<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Трансляция экрана</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #video-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        video {
            width: 90%; /* Увеличено с 80% до 90% */
            max-width: 1400px; /* Установлен максимальный размер видео */
            height: auto; /* Поддерживает пропорции экрана */
            border: 1px solid #ccc;
            margin: 10px;
            border-radius: 10px; /* Скругленные углы */
        }
        #controls {
            text-align: center;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            background-color: #ccc;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div id="controls">
    <h1>Добро пожаловать в видеоконференцию</h1>
    <div id="role-selection">
        <button onclick="setRole('teacher')">Я учитель</button>
        <button onclick="setRole('student')">Я ученик</button>
    </div>

    <div id="teacher-controls" class="hidden">
        <h2>Управление трансляцией</h2>
        <button id="start-broadcast" onclick="startBroadcast()">Начать трансляцию экрана</button>
        <button id="stop-broadcast" class="hidden" onclick="stopBroadcast()">Остановить трансляцию</button>
    </div>

    <div id="student-view" class="hidden">
        <h2>Просмотр трансляции</h2>
        <div id="video-container" >
            <video id="video-player" autoplay></video>
        </div>
    </div>
</div>

<script>
    let role = null;
    let socket = null;
    let peerConnection = null;
    let videoElement = document.getElementById('video-player');
    let screenStream = null;

    // Функция для выбора роли (учитель/ученик)
    function setRole(selectedRole) {
        role = selectedRole;
        document.getElementById('role-selection').classList.add('hidden');

        if (role === 'teacher') {
            document.getElementById('teacher-controls').classList.remove('hidden');
        } else if (role === 'student') {
            document.getElementById('student-view').classList.remove('hidden');
            connectToRoom('student');
        }
    }

    // Функция для начала трансляции экрана (для учителя)
    function startBroadcast() {
        // Запрашиваем разрешение на захват экрана
        navigator.mediaDevices.getDisplayMedia({ video: true })
            .then(stream => {
                screenStream = stream;

                // Создаем WebSocket соединение
                socket = new WebSocket('ws://' + location.host + '/websocket?role=teacher');
                socket.onopen = () => {
                    console.log('Connected to WebSocket as teacher');
                    setupPeerConnection('teacher', screenStream);
                };

                socket.onmessage = handleSocketMessage;

                document.getElementById('start-broadcast').classList.add('hidden');
                document.getElementById('stop-broadcast').classList.remove('hidden');
            })
            .catch(err => {
                console.error('Error capturing screen: ', err);
            });
    }

    // Функция для остановки трансляции (для учителя)
    function stopBroadcast() {
        if (peerConnection) {
            peerConnection.close();
        }
        if (screenStream) {
            screenStream.getTracks().forEach(track => track.stop());
        }
        if (socket) {
            socket.close();
        }

        document.getElementById('start-broadcast').classList.remove('hidden');
        document.getElementById('stop-broadcast').classList.add('hidden');
    }

    // Функция для подключения ученика
    function connectToRoom(role) {
        socket = new WebSocket('ws://' + location.host + '/websocket?role=' + role);
        socket.onopen = () => {
            console.log('Connected to WebSocket as student');
            setupPeerConnection('student');
        };

        socket.onmessage = handleSocketMessage;
    }

    // Обработка сообщений от WebSocket
    function handleSocketMessage(event) {
        const message = JSON.parse(event.data);

        switch (message.event) {
            case 'offer':
                handleOffer(message.data);
                break;
            case 'candidate':
                handleCandidate(message.data);
                break;
            case 'answer':
                handleAnswer(message.data);
                break;
            default:
                console.error('Unknown message type:', message);
        }
    }

    // Установка peer connection для учителя или ученика
    function setupPeerConnection(role, stream = null) {
        peerConnection = new RTCPeerConnection();

        // Если это ученик, получаем только видеопоток
        if (role === 'student') {
            peerConnection.ontrack = (event) => {
                // Просмотр полученного видео
                videoElement.srcObject = event.streams[0];
            };
        } else if (role === 'teacher' && stream) {
            // Для учителя: отправляем захваченный экран
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        }

        // Устанавливаем обработчики для ICE кандидатов
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    event: 'candidate',
                    data: JSON.stringify(event.candidate)
                }));
            }
        };
    }

    // Обработка SDP offer
    function handleOffer(offerData) {
        const offer = JSON.parse(offerData);
        peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
            .then(() => {
                return peerConnection.createAnswer();
            })
            .then((answer) => {
                return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
                socket.send(JSON.stringify({
                    event: 'answer',
                    data: JSON.stringify(peerConnection.localDescription)
                }));
            })
            .catch((error) => {
                console.error('Error handling offer:', error);
            });
    }

    // Обработка ICE кандидатов
    function handleCandidate(candidateData) {
        const candidate = JSON.parse(candidateData);
        peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
            .catch((error) => {
                console.error('Error adding received ICE candidate', error);
            });
    }

    // Обработка SDP answer
    function handleAnswer(answerData) {
        const answer = JSON.parse(answerData);
        peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    }
</script>

</body>
</html>
